#!/bin/bash

# Конфигурация
APPS_LIST_FILE="apps_list.txt"

# Проверка наличия файла со списком приложений
if [[ ! -f "$APPS_LIST_FILE" ]]; then
    echo "Ошибка: Файл со списком приложений '$APPS_LIST_FILE' не найден!"
    echo "Убедитесь, что он находится в той же папке, что и скрипт."
    exit 1
fi

# Проверка подключения устройства ADB
echo "Проверка подключения ADB..."
adb devices | grep -w "device" > /dev/null
if [[ $? -ne 0 ]]; then
    echo "Ошибка: Устройство не подключено или не разрешена отладка по USB!"
    echo "1. Включите 'Отладку по USB' в настройках разработчика"
    echo "2. Подключите устройство кабелем"
    echo "3. Подтвердите разрешение отладки на телефоне"
    exit 1
fi

echo "Устройство подключено успешно."
echo "=========================================="

# Чтение списка приложений из файла
echo "Читаю список приложений из файла '$APPS_LIST_FILE'..."
apps=()
while IFS= read -r line; do
    # Пропускаем пустые строки и строки, начинающиеся с #
    [[ -z "$line" ]] && continue
    [[ "$line" =~ ^[[:space:]]*# ]] && continue

    # Добавляем строку в массив
    apps+=("$line")
done < "$APPS_LIST_FILE"

echo "Найдено приложений для обработки: ${#apps[@]}"
echo "Начинаем удаление..."
echo "=========================================="

# Удаление приложений из списка
for app_line in "${apps[@]}"; do
    # Извлекаем только package name (первое слово до пробела)
    package_name=$(echo "$app_line" | awk '{print $1}')

    # Извлекаем комментарий (все после первого слова)
    comment=$(echo "$app_line" | cut -d' ' -f2-)

    # Проверяем, является ли пакет валидным (содержит точку)
    if [[ "$package_name" != *.* ]]; then
        echo "Пропускаем некорректный пакет: '$package_name'"
        continue
    fi

    echo "Обрабатываю: $package_name - ${comment:-без описания}"

    # Проверяем, установлено ли приложение
    if adb shell pm list packages | grep -q "$package_name"; then
        echo "  ✓ Установлено, удаляю..."
        adb shell pm uninstall -k --user 0 "$package_name"
        if [[ $? -eq 0 ]]; then
            echo "  ✓ Успешно удалено"
        else
            echo "  ✗ Ошибка при удалении"
        fi
    else
        echo "  ✗ Не установлено, пропускаю"
    fi

    # Небольшая пауза между командами
    sleep 0.1
done

echo "=========================================="
echo "Удаление завершено!"
echo ""
echo "Рекомендации:"
echo "1. Перезагрузите устройство для применения изменений"
echo "2. Проверьте, нет ли проблем с системными функциями"
echo "3. При необходимости можно восстановить приложения командой:"
echo "   adb shell cmd package install-existing <package_name>"
